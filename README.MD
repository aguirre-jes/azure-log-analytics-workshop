# Azure Log Analytics Workshop

Este workshop te enseÃ±a los fundamentos de Azure Log Analytics a travÃ©s de una aplicaciÃ³n prÃ¡ctica que demuestra la agregaciÃ³n de logs y creaciÃ³n de alertas bÃ¡sicas.

## ğŸ¯ Objetivos del Workshop

Al completar este workshop, habrÃ¡s aprendido:

- âœ… CÃ³mo configurar Azure Log Analytics y Application Insights
- âœ… Enviar logs estructurados desde una aplicaciÃ³n Python
- âœ… Ejecutar consultas KQL para analizar logs
- âœ… Crear alertas bÃ¡sicas basadas en consultas
- âœ… Usar Infrastructure as Code (Terraform) para Azure

## ğŸ“‹ Prerrequisitos

Para instrucciones detalladas y recomendaciones, consulta la guÃ­a:  [docs/01-prerequisites.md](docs/01-prerequisites.md)

- **Cuenta de Azure** con permisos para crear recursos
- **Docker Desktop o Podman Desktop** instalado y funcionando
- **Visual Studio Code** con extensiÃ³n Dev Containers
- **Azure CLI** instalado (opcional, se incluye en el devcontainer)

## âš™ï¸ ConfiguraciÃ³n Inicial CrÃ­tica

### **ğŸš¨ IMPORTANTE: Configurar tu Container Engine**

Para instrucciones detalladas y recomendaciones, consulta la guÃ­a:  [docs/01-devcontainer-setup](docs/01-devcontainer-setup)

Antes de abrir el devcontainer, **debes configurar VS Code** para usar tu engine de contenedores:

#### **Si usas Docker Desktop:**
1. Abre VS Code
2. Ve a **Settings** (`Cmd/Ctrl + ,`)
3. Busca: `dev.containers.dockerPath`
4. Configura el valor como: `docker`

#### **Si usas Podman Desktop:**
1. Abre VS Code
2. Ve a **Settings** (`Cmd/Ctrl + ,`)
3. Busca: `dev.containers.dockerPath` 
4. Configura el valor como: `podman`

**ğŸ“¸ Captura Visual:**
```
Settings > Extensions > Dev Containers
â”œâ”€â”€ Docker Path: [docker] o [podman]
â””â”€â”€ âœ… Restart Required: Reinicia VS Code despuÃ©s de cambiar
```

> **ğŸ’¡ Sin esta configuraciÃ³n, el devcontainer fallarÃ¡ al construirse.**

## ğŸš€ Inicio RÃ¡pido

### 1. Configurar VS Code para tu Container Engine

**ğŸ”§ PASO OBLIGATORIO ANTES DE CONTINUAR:**

1. **Abre VS Code**
2. **Abre Settings**: `Cmd/Ctrl + ,` o `File > Preferences > Settings`
3. **Busca**: `dev.containers.dockerPath`
4. **Configura segÃºn tu setup**:
   - Si tienes **Docker Desktop**: escribe `docker`
   - Si tienes **Podman Desktop**: escribe `podman`
5. **Reinicia VS Code** completamente

**ğŸ–¼ï¸ UbicaciÃ³n Visual:**
```
VS Code Settings
â””â”€â”€ Extensions
    â””â”€â”€ Dev Containers
        â””â”€â”€ Docker Path: [tu-engine-aquÃ­]
```

### 2. Clonar y Abrir el Proyecto

```bash
git clone https://github.com/aguirre-jes/azure-log-analytics-workshop
cd azure-log-analytics-workshop
code .
```

### 3. Abrir en Dev Container

1. **VS Code te preguntarÃ¡** si quieres reabrir en container - **acepta**
2. **O manualmente**: `Cmd/Ctrl + Shift + P` â†’ "Dev Containers: Reopen in Container"
3. **Espera** a que se construya el container (primera vez toma 5-10 minutos)

**ğŸš¨ Si el container falla al construirse:**
- Verifica que configuraste correctamente `dev.containers.dockerPath`
- AsegÃºrate que Docker/Podman Desktop estÃ© corriendo
- Reinicia VS Code completamente
- Intenta: `Cmd/Ctrl + Shift + P` â†’ "Dev Containers: Rebuild Container"

**âœ… SabrÃ¡s que funciona cuando veas:**
- Terminal con prompt del container (usualmente `vscode@...`)
- Las extensiones de Python y Azure cargadas automÃ¡ticamente

### 4. Configurar Variables de Azure

**En el terminal del devcontainer** (deberÃ­a mostrar `vscode@...:`):

```bash
# Copiar template de variables
cp terraform/terraform.tfvars.example terraform/terraform.tfvars
```

Edita `terraform/terraform.tfvars` con tus valores:

```hcl
subscription_id = "tu-azure-subscription-id"
admin_email = "tu-email@ejemplo.com"
```

### 4. Deploy de Infraestructura

Para instrucciones detalladas y recomendaciones, consulta la guÃ­a:  [docs/02-infrastructure-deployment.md](docs/02-infrastructure-deployment.md)

```bash
# Login a Azure
az login

# Deploy con Terraform
cd terraform
terraform init
terraform plan
terraform apply
```

### 5. Configurar la AplicaciÃ³n

Para instrucciones detalladas y recomendaciones, consulta la guÃ­a:  
[docs/03-application-setup](docs/03-application-setup)

```bash
# Obtener connection string
export APPLICATIONINSIGHTS_CONNECTION_STRING=$(terraform output -raw application_insights_connection_string)

# Verificar configuraciÃ³n
cd ../src
python config.py
```

### 6. Ejecutar la Demo

```bash
# Ejecutar aplicaciÃ³n
python app.py

# Deja correr por 3-5 minutos para generar datos
# Usa Ctrl+C para detener
```

### 7. Explorar en Azure Portal

Para instrucciones detalladas y recomendaciones, consulta la guÃ­a:  [docs/04-exploring-logs](docs/04-exploring-logs)

1. Ve a [Azure Portal](https://portal.azure.com)
2. Busca tu Log Analytics Workspace
3. Ve a "Logs" y ejecuta las consultas del archivo `queries/basic-queries.kql`

## ğŸ“š Estructura del Proyecto

```
azure-log-analytics-workshop/
â”œâ”€â”€ .devcontainer/          # ConfiguraciÃ³n del desarrollo en container
â”œâ”€â”€ terraform/              # Infraestructura como cÃ³digo
â”œâ”€â”€ src/                    # AplicaciÃ³n Python
â”œâ”€â”€ queries/                # Consultas KQL de ejemplo
â”œâ”€â”€ docs/                   # DocumentaciÃ³n detallada del workshop
â””â”€â”€ scripts/                # Scripts de utilidad
```

## ğŸ” Consultas KQL Incluidas

El archivo `queries/basic-queries.kql` contiene ejemplos de:

- Ver todos los logs recientes
- Filtrar por nivel de error
- Agrupar operaciones por usuario
- Crear grÃ¡ficos de timeline
- Detectar patrones de errores

## ğŸš¨ Crear tu Primera Alerta

Para instrucciones detalladas y recomendaciones, consulta la guÃ­a: [docs/05-creating-alerts](docs/05-creating-alerts)

1. En Azure Portal â†’ Log Analytics â†’ Logs
2. Ejecuta esta consulta:
   ```kql
   AppTraces
   | where TimeGenerated > ago(5m)
   | where SeverityLevel >= 3
   | summarize error_count = count()
   ```
3. Haz clic en "New Alert Rule"
4. Configura condiciÃ³n: `count > 5`
5. Agrega acciÃ³n: Email notification

## ğŸ§¹ Limpieza

Para eliminar todos los recursos creados:

```bash
cd terraform
terraform destroy
```

## ğŸ“– DocumentaciÃ³n Detallada

- [Prerrequisitos](docs/00-prerequisites.md)
- [ConfiguraciÃ³n del Dev Container](docs/01-devcontainer-setup.md)
- [Deploy de Infraestructura](docs/02-infrastructure-deployment.md)
- [ConfiguraciÃ³n de la AplicaciÃ³n](docs/03-application-setup.md)
- [Explorando Logs](docs/04-exploring-logs.md)
- [Creando Alertas](docs/05-creating-alerts.md)

## â“ Troubleshooting

### âŒ Error: "No such file or directory" al construir container
**Causa:** Error de configuraciÃ³n en `dev.containers.dockerPath`
**SoluciÃ³n:**
1. Ve a VS Code Settings â†’ `dev.containers.dockerPath`
2. AsegÃºrate que dice `docker` o `podman` segÃºn tu setup
3. Reinicia VS Code completamente
4. `Cmd/Ctrl + Shift + P` â†’ "Dev Containers: Rebuild Container"

### âŒ Container no se construye o falla
**Verificaciones:**
1. **Docker/Podman Desktop estÃ¡ corriendo** âœ…
2. **VS Code tiene la extensiÃ³n "Dev Containers"** instalada âœ…
3. **Configuraste `dev.containers.dockerPath`** correctamente âœ…
4. **Tienes permisos** para ejecutar containers âœ…

**Comandos de debug:**
```bash
# Verificar que tu engine estÃ¡ funcionando
docker version   # Si usas Docker
podman version   # Si usas Podman

# Ver configuraciÃ³n actual de VS Code
code --list-extensions | grep containers
```

### âŒ Error: "Connection string not configured"
**Causa:** Variables de entorno no configuradas correctamente
**SoluciÃ³n:**
- Verifica que la variable `APPLICATIONINSIGHTS_CONNECTION_STRING` estÃ© exportada
- Ejecuta `python src/config.py` para verificar configuraciÃ³n
- AsegÃºrate de estar en el terminal del devcontainer

### âŒ No veo logs en Azure Portal
**Posibles causas:**
- Espera **2-3 minutos** despuÃ©s de ejecutar la app (hay delay normal)
- Verifica que la connection string sea correcta
- Revisa que no haya errores en la consola de la aplicaciÃ³n
- Confirma que los recursos de Azure se crearon correctamente

### ğŸ†˜ Comandos de Emergencia

Si todo falla, ejecuta en orden:

```bash
# 1. Verificar engine
docker --version    # o podman --version

# 2. Reconstruir container desde cero
# En VS Code: Cmd/Ctrl + Shift + P
# â†’ "Dev Containers: Rebuild Container (No Cache)"

# 3. Si persiste, eliminar y recrear
# â†’ "Dev Containers: Clean Up Dev Containers..."
```

## ğŸ¤ Contribuir

Â¿Encontraste un error o tienes una mejora? Â¡Crea un issue o PR!

## ğŸ“„ Licencia

Este proyecto estÃ¡ bajo licencia MIT. Ver [LICENSE](LICENSE) para mÃ¡s detalles.

---

**Â¡Feliz aprendizaje! ğŸ‰**